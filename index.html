<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>hi</title>
<style>
body { font-family: system-ui; background: #0f172a; color: #e5e7eb; margin: 0; }
.container { max-width: 720px; margin: auto; padding: 40px; }
h1,h2 { margin-top: 30px; }
input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: none; }
button { background: #2563eb; color: white; cursor: pointer; }
.card { background: #020617; border: 1px solid #1e293b; padding: 15px; border-radius: 8px; margin-top: 15px; }
.hidden { display: none; }
</style>
</head>
<body>

<div class="container">
<h1>hello</h1>

<input id="publicQuery" placeholder="Type username, display name, or card ID" oninput="debouncedPublicLookup()">
<button onclick="publicLookup()">Search</button>
<div id="publicResult" class="card hidden"></div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden">
<hr>
<h2>Admin Panel</h2>
<input id="adminPass" type="password" placeholder="Admin Passcode">
<input id="adminQuery" placeholder="Username or Card ID">
<button onclick="adminLookup()">Lookup</button>
<div id="adminResult" class="card hidden"></div>

<h2>Add / Edit Entry</h2>
<input id="displayName" placeholder="Display Name">
<input id="username" placeholder="Username">
<input id="gender" placeholder="Gender">
<input id="nationality" placeholder="Nationality">
<input id="dob" placeholder="Date of Birth">
<input id="nativeLanguage" placeholder="Native Language">
<input id="expiry" placeholder="Expiry Date">
<input id="given" placeholder="Date Given">
<input id="cardId" placeholder="Card ID">
<button onclick="submitEntry()">Save Entry</button>
</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyoObnbMZCVnwov7HDTHOfEEg_rSq15xE-LUZY9NoX3eYAorGNzbGVWrcFoeLOnVdiz6w/exec";
let editRow = null;

/* ---------- DEBOUNCE ---------- */
let searchTimer = null;
function debouncedPublicLookup() {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    if(publicQuery.value.trim() === "") { publicResult.classList.add("hidden"); return; }
    publicLookup();
  },300);
}

/* ---------- API CALL ---------- */
async function call(payload) {
  try {
    const r = await fetch(API, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    return await r.json();
  } catch(err) {
    console.error("API call failed", err);
    return {error:"API call failed"};
  }
}

/* ---------- PUBLIC SEARCH ---------- */
async function publicLookup() {
  const queryVal = publicQuery.value.trim();
  if(queryVal==="") { publicResult.classList.add("hidden"); return; }
  const d = await call({ action:"publicLookup", query: queryVal, partial:true });

  if(!d || d.error || d.length===0) {
    publicResult.textContent="No match found";
    publicResult.classList.remove("hidden");
    return;
  }

  publicResult.innerHTML = d.map(e => `
    <b>${e.displayName}</b><br>
    Username: ${e.username}<br>
    Gender: ${e.gender}<br>
    Nationality: ${e.nationality}<br>
    Native Language: ${e.nativeLanguage}<br>
    Card ID: ${e.cardId}
  `).join("<hr>");
  publicResult.classList.remove("hidden");
}

/* ---------- ADMIN LOOKUP ---------- */
async function adminLookup() {
  const pass = document.getElementById("adminPass").value;
  const query = document.getElementById("adminQuery").value.trim();
  if(!pass || !query) { alert("Enter passcode and query"); return; }

  const d = await call({ action:"adminLookup", passcode:pass, query:query });

  if(d.error) { alert(d.error); return; }

  editRow = d.row;
  const r = d.data;
  [displayName, username, gender, nationality, dob, nativeLanguage, expiry, given, cardId].forEach((el,i)=>el.value=r[i]);
  adminResult.textContent="Record loaded for editing.";
  adminResult.classList.remove("hidden");
}

/* ---------- ADMIN SAVE ---------- */
async function submitEntry() {
  const pass = document.getElementById("adminPass").value;
  if(!pass) { alert("Enter passcode"); return; }

  const payload = {
    action: editRow?"update":"add",
    passcode: pass,
    row: editRow,
    displayName: displayName.value,
    username: username.value,
    gender: gender.value,
    nationality: nationality.value,
    dob: dob.value,
    nativeLanguage: nativeLanguage.value,
    expiry: expiry.value,
    given: given.value,
    cardId: cardId.value
  };
  const d = await call(payload);
  if(d.error) alert(d.error);
  else alert("Saved successfully");
}

/* ---------- ADMIN KEYBOARD SEQUENCE ---------- */
const adminSequence=['A','D','M','I','N'];
let currentIndex=0;
document.addEventListener('keydown', function(e){
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.key.toUpperCase()===adminSequence[currentIndex]){
    currentIndex++;
    if(currentIndex===adminSequence.length){
      document.getElementById('adminPanel').classList.remove('hidden');
      currentIndex=0;
    }
  } else { currentIndex=0; }
});
</script>
</body>
</html>

