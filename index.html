<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mockgov International ID Lookup</title>
<style>
  /* --- Basic Layout --- */
  body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin:0; padding:0;}
  .container { max-width: 800px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1);}
  h1 { text-align: center; color: #1e293b; }
  input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 16px; }
  button { background: #2563eb; color: #fff; border: none; cursor: pointer; transition: 0.2s; }
  button:hover { background: #1d4ed8; }
  .card { background: #f1f5f9; padding: 15px; margin-top: 15px; border-radius: 8px; border: 1px solid #cbd5e1; }
  .hidden { display: none; }
  .admin-section hr { margin: 20px 0; border-color: #cbd5e1; }
  .version { text-align:right; font-size:12px; color:#64748b; margin-top:10px; }
</style>
</head>
<body>

<div class="container">
  <h1>Mockgov International ID Lookup 1.0</h1>

  <!-- Search Field -->
  <input id="searchField" placeholder="Search username, display name, or card ID (Type password to unlock admin)">
  <button onclick="publicSearch()">Search</button>
  <div id="publicResult" class="card hidden"></div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden admin-section">
    <h2>Admin Panel</h2>
    <input id="adminQuery" placeholder="Search by username or card ID">
    <button onclick="adminLookup()">Lookup</button>
    <div id="adminResult" class="card hidden"></div>

    <h3>Add / Edit Entry</h3>
    <input id="displayName" placeholder="Display Name">
    <input id="username" placeholder="Username">
    <input id="gender" placeholder="Gender">
    <input id="nationality" placeholder="Nationality">
    <input id="dob" placeholder="Date of Birth">
    <input id="nativeLanguage" placeholder="Native Language">
    <input id="expiry" placeholder="Expiry Date">
    <input id="given" placeholder="Date Given">
    <input id="cardId" placeholder="Card ID">
    <button onclick="saveEntry()">Save Entry</button>
  </div>

  <div class="version">Version 1.0</div>
</div>

<script>
let API = "";
let editRow = null;
const ADMIN_PASSWORD = "appsscript";

// Load API URL from config.json
fetch("config.json")
  .then(r => r.json())
  .then(d => { API = d.API; })
  .catch(err => { console.error("Failed to load API URL", err); });

// Debounce timer for search-as-you-type
let debounceTimer = null;
document.getElementById("searchField").addEventListener("input", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const val = searchField.value.trim();
    if(!val){ publicResult.classList.add("hidden"); return; }

    // Unlock admin panel if password typed
    if(val === ADMIN_PASSWORD){
      adminPanel.classList.remove("hidden");
      searchField.value = "";
      publicResult.classList.add("hidden");
      return;
    }
    publicSearch();
  }, 250);
});

// Central API call
async function callAPI(payload){
  if(!API){ alert("API URL not loaded yet"); return; }
  try {
    const r = await fetch(API, { 
      method: "POST", 
      headers: { "Content-Type": "application/json" },  // IMPORTANT fix
      body: JSON.stringify(payload)
    });
    return await r.json();
  } catch(err){
    console.error("API call failed", err);
    alert("API call failed");
    return { error: "API call failed" };
  }
}

// Public search
async function publicSearch(){
  const query = searchField.value.trim();
  if(!query){ publicResult.classList.add("hidden"); return; }

  const data = await callAPI({ action: "publicLookup", query, partial:true });
  if(!data || data.error || data.length===0){
    publicResult.textContent = "No match found";
    publicResult.classList.remove("hidden");
    return;
  }

  publicResult.innerHTML = data.map(e => `
    <b>${e.displayName}</b><br>
    Username: ${e.username}<br>
    Gender: ${e.gender}<br>
    Nationality: ${e.nationality}<br>
    Native Language: ${e.nativeLanguage}<br>
    Card ID: ${e.cardId}
  `).join("<hr>");
  publicResult.classList.remove("hidden");
}

// Admin lookup
async function adminLookup(){
  const query = adminQuery.value.trim();
  if(!query){ alert("Enter query"); return; }

  const data = await callAPI({ action: "adminLookup", passcode: ADMIN_PASSWORD, query });
  if(data.error){ alert(data.error); return; }

  editRow = data.row;
  const r = data.data;
  [displayName, username, gender, nationality, dob, nativeLanguage, expiry, given, cardId].forEach((el,i)=>el.value=r[i]);
  adminResult.textContent = "Record loaded for editing";
  adminResult.classList.remove("hidden");
}

// Save or add entry
async function saveEntry(){
  const payload = {
    action: editRow ? "update" : "add",
    passcode: ADMIN_PASSWORD,
    row: editRow,
    displayName: displayName.value,
    username: username.value,
    gender: gender.value,
    nationality: nationality.value,
    dob: dob.value,
    nativeLanguage: nativeLanguage.value,
    expiry: expiry.value,
    given: given.value,
    cardId: cardId.value
  };
  const data = await callAPI(payload);
  if(data.error) alert(data.error);
  else { alert("Saved successfully"); editRow = null; }
}
</script>

</body>
</html>
